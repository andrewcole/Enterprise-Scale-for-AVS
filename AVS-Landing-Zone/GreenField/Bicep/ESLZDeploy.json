{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1272.37030",
      "templateHash": "6787838192337691081"
    }
  },
  "parameters": {
    "ELZLocation": {
      "type": "string",
      "defaultValue": "AustraliaCentral",
      "metadata": {
        "description": "The region the Enterpise Landing Zone and associated resources will be deployed to"
      },
      "allowedValues": [
        "AustraliaCentral",
        "AustraliaCentral2"
      ]
    },
    "AVSLocation": {
      "type": "string",
      "defaultValue": "AustraliaEast",
      "metadata": {
        "description": "The region the AVS Private Cloud & associated resources will be deployed to"
      },
      "allowedValues": [
        "AustraliaEast",
        "AustraliaSouthEast",
        "NorthEurope"
      ]
    },
    "Prefix": {
      "type": "string",
      "defaultValue": "SBB",
      "maxLength": 20,
      "minLength": 1,
      "metadata": {
        "description": "The prefix to use on resources inside this template"
      }
    },
    "PrivateCloudAddressSpace": {
      "type": "string",
      "defaultValue": "10.0.0.0/22",
      "metadata": {
        "description": "The address space used for the AVS Private Cloud management networks. Must be a non-overlapping /22"
      }
    },
    "VNetName": {
      "type": "string",
      "metadata": {
        "description": "Specify the name of the VNet"
      }
    },
    "NetworkResourceGroup": {
      "type": "string",
      "metadata": {
        "description": "Specify the name of the Network Resource Group"
      }
    },
    "VNetGatewaySubnet": {
      "type": "string",
      "defaultValue": "10.1.1.128/26",
      "metadata": {
        "description": "The subnet CIDR used for the Gateway Subnet. Must be a /24 or greater within the VNetAddressSpace"
      }
    },
    "AlertEmails": {
      "type": "array",
      "defaultValue": [
        "francois.legrange@microsoft.com"
      ],
      "metadata": {
        "description": "Email addresses to be added to the alerting action group. Use the format [\"name1@domain.com\",\"name2@domain.com\"]."
      }
    },
    "DeployJumpbox": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Should a Jumpbox deployed to access the Private Cloud"
      }
    },
    "PublicIP": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Should a Public IP be assigned to the Jumpbox"
      }
    },
    "DeployMigrationSubnet": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Should a Migration subnet be deployed"
      }
    },
    "JumpboxUsername": {
      "type": "string",
      "defaultValue": "avsjump",
      "metadata": {
        "description": "Username for the Jumpbox VM"
      }
    },
    "JumpboxPassword": {
      "type": "secureString",
      "metadata": {
        "description": "Password for the Jumpbox VM, can be changed later"
      }
    },
    "JumpboxSubnet": {
      "type": "string",
      "defaultValue": "10.1.1.0/26",
      "metadata": {
        "description": "The subnet CIDR used for the Jumpbox VM Subnet. Must be a /26 or greater within the VNetAddressSpace"
      }
    },
    "JumpboxSku": {
      "type": "string",
      "defaultValue": "Standard_D2s_v3",
      "metadata": {
        "description": "The sku to use for the Jumpbox VM, must have quota for this within the target region"
      }
    },
    "DeployStorage": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Should some storage be deployed to the ELZ"
      }
    },
    "StorageName": {
      "type": "string",
      "metadata": {
        "description": "Specify the name of the Storage Account"
      }
    },
    "MigrationSubnet": {
      "type": "string",
      "defaultValue": "10.1.1.64/26",
      "metadata": {
        "description": "The subnet CIDR used for the Migration Subnet. Must be a /26 or greater within the VNetAddressSpace"
      }
    },
    "DeployHCX": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Should HCX be deployed as part of the deployment"
      }
    },
    "DeploySRM": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Should SRM be deployed as part of the deployment"
      }
    },
    "SRMLicenseKey": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "License key to be used if SRM is deployed"
      }
    },
    "ManagementClusterSize": {
      "type": "int",
      "defaultValue": 3,
      "metadata": {
        "description": "Number of vSphere ESXi hosts to be created"
      },
      "maxValue": 12,
      "minValue": 3
    },
    "VRServerCount": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Number of vSphere Replication Servers to be created if SRM is deployed"
      },
      "maxValue": 10,
      "minValue": 1
    }
  },
  "variables": {
    "deploymentPrefix": "[format('AVS-{0}', uniqueString(deployment().name))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-AVS', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "Location": {
            "value": "[parameters('AVSLocation')]"
          },
          "PrivateCloudAddressSpace": {
            "value": "[parameters('PrivateCloudAddressSpace')]"
          },
          "ManagementClusterSize": {
            "value": "[parameters('ManagementClusterSize')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "12496491217868060056"
            }
          },
          "parameters": {
            "Location": {
              "type": "string"
            },
            "Prefix": {
              "type": "string"
            },
            "PrivateCloudAddressSpace": {
              "type": "string"
            },
            "ManagementClusterSize": {
              "type": "int"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-PrivateCloud', parameters('Prefix'))]",
              "location": "[parameters('Location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-PrivateCloud', deployment().name)]",
              "resourceGroup": "[format('{0}-PrivateCloud', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "NetworkBlock": {
                    "value": "[parameters('PrivateCloudAddressSpace')]"
                  },
                  "ManagementClusterSize": {
                    "value": "[parameters('ManagementClusterSize')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "2224239744318720774"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "NetworkBlock": {
                      "type": "string"
                    },
                    "ManagementClusterSize": {
                      "type": "int"
                    },
                    "Location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.AVS/privateClouds",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}-SDDC', parameters('Prefix'))]",
                      "sku": {
                        "name": "AV36"
                      },
                      "location": "[parameters('Location')]",
                      "properties": {
                        "networkBlock": "[parameters('NetworkBlock')]",
                        "managementCluster": {
                          "clusterSize": "[parameters('ManagementClusterSize')]"
                        },
                        "internet": "Disabled"
                      }
                    }
                  ],
                  "outputs": {
                    "PrivateCloudName": {
                      "type": "string",
                      "value": "[format('{0}-SDDC', parameters('Prefix'))]"
                    },
                    "PrivateCloudResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.AVS/privateClouds', format('{0}-SDDC', parameters('Prefix')))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-PrivateCloud', parameters('Prefix')))]"
              ]
            }
          ],
          "outputs": {
            "PrivateCloudName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-PrivateCloud', deployment().name))).outputs.PrivateCloudName.value]"
            },
            "PrivateCloudResourceGroupName": {
              "type": "string",
              "value": "[format('{0}-PrivateCloud', parameters('Prefix'))]"
            },
            "PrivateCloudResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-PrivateCloud', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-PrivateCloud', deployment().name))).outputs.PrivateCloudResourceId.value]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-Network', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "Location": {
            "value": "[parameters('ELZLocation')]"
          },
          "VNetGatewaySubnet": {
            "value": "[parameters('VNetGatewaySubnet')]"
          },
          "VNetName": {
            "value": "[parameters('VNetName')]"
          },
          "NetworkResourceGroup": {
            "value": "[parameters('NetworkResourceGroup')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "15878536429122864045"
            }
          },
          "parameters": {
            "Location": {
              "type": "string"
            },
            "Prefix": {
              "type": "string"
            },
            "VNetGatewaySubnet": {
              "type": "string"
            },
            "VNetName": {
              "type": "string"
            },
            "NetworkResourceGroup": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-Network', deployment().name)]",
              "resourceGroup": "[parameters('NetworkResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "VNetGatewaySubnet": {
                    "value": "[parameters('VNetGatewaySubnet')]"
                  },
                  "VNetName": {
                    "value": "[parameters('VNetName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "18119311186681128529"
                    }
                  },
                  "parameters": {
                    "Location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "Prefix": {
                      "type": "string"
                    },
                    "VNetGatewaySubnet": {
                      "type": "string"
                    },
                    "GatewaySku": {
                      "type": "string",
                      "defaultValue": "Standard"
                    },
                    "VNetName": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "GatewayName": "[format('{0}-GW', parameters('Prefix'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/{1}', parameters('VNetName'), 'GatewaySubnet')]",
                      "properties": {
                        "addressPrefix": "[parameters('VNetGatewaySubnet')]"
                      }
                    },
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}-PIP', variables('GatewayName'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "publicIPAllocationMethod": "Dynamic"
                      },
                      "sku": {
                        "name": "Basic",
                        "tier": "Regional"
                      }
                    },
                    {
                      "type": "Microsoft.Network/virtualNetworkGateways",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('GatewayName')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "gatewayType": "ExpressRoute",
                        "sku": {
                          "name": "[parameters('GatewaySku')]",
                          "tier": "[parameters('GatewaySku')]"
                        },
                        "ipConfigurations": [
                          {
                            "name": "default",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('VNetName'), 'GatewaySubnet')]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-PIP', variables('GatewayName')))]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-PIP', variables('GatewayName')))]",
                        "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('VNetName'), 'GatewaySubnet')]"
                      ]
                    }
                  ],
                  "outputs": {
                    "VNetName": {
                      "type": "string",
                      "value": "[parameters('VNetName')]"
                    },
                    "GatewayName": {
                      "type": "string",
                      "value": "[variables('GatewayName')]"
                    },
                    "VNetResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('VNetName'))]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "GatewayName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('NetworkResourceGroup')), 'Microsoft.Resources/deployments', format('{0}-Network', deployment().name))).outputs.GatewayName.value]"
            },
            "VNetName": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('NetworkResourceGroup')), 'Microsoft.Resources/deployments', format('{0}-Network', deployment().name))).outputs.VNetName.value]"
            },
            "VNetResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('NetworkResourceGroup')), 'Microsoft.Resources/deployments', format('{0}-Network', deployment().name))).outputs.VNetResourceId.value]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-VNet', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "GatewayName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-Network', variables('deploymentPrefix')))).outputs.GatewayName.value]"
          },
          "NetworkResourceGroup": {
            "value": "[parameters('NetworkResourceGroup')]"
          },
          "VNetPrefix": {
            "value": "[parameters('Prefix')]"
          },
          "PrivateCloudName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-AVS', variables('deploymentPrefix')))).outputs.PrivateCloudName.value]"
          },
          "PrivateCloudResourceGroup": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-AVS', variables('deploymentPrefix')))).outputs.PrivateCloudResourceGroupName.value]"
          },
          "Location": {
            "value": "[parameters('ELZLocation')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "17450947667449820639"
            }
          },
          "parameters": {
            "VNetPrefix": {
              "type": "string"
            },
            "AVSPrefix": {
              "type": "string",
              "defaultValue": "[parameters('VNetPrefix')]"
            },
            "PrivateCloudResourceGroup": {
              "type": "string"
            },
            "PrivateCloudName": {
              "type": "string"
            },
            "NetworkResourceGroup": {
              "type": "string"
            },
            "GatewayName": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-ExRAuth', deployment().name)]",
              "resourceGroup": "[parameters('PrivateCloudResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ConnectionName": {
                    "value": "[format('{0}-VNet', parameters('VNetPrefix'))]"
                  },
                  "PrivateCloudName": {
                    "value": "[parameters('PrivateCloudName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "5131100314591469562"
                    }
                  },
                  "parameters": {
                    "PrivateCloudName": {
                      "type": "string"
                    },
                    "ConnectionName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.AVS/privateClouds/authorizations",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}/{1}', parameters('PrivateCloudName'), parameters('ConnectionName'))]"
                    }
                  ],
                  "outputs": {
                    "ExpressRouteAuthorizationKey": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.AVS/privateClouds/authorizations', parameters('PrivateCloudName'), parameters('ConnectionName'))).expressRouteAuthorizationKey]"
                    },
                    "ExpressRouteId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.AVS/privateClouds', parameters('PrivateCloudName')), '2021-06-01').circuit.expressRouteID]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-ExR', deployment().name)]",
              "resourceGroup": "[parameters('NetworkResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ConnectionName": {
                    "value": "[format('{0}-AVS', parameters('AVSPrefix'))]"
                  },
                  "GatewayName": {
                    "value": "[parameters('GatewayName')]"
                  },
                  "ExpressRouteAuthorizationKey": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', format('{0}-ExRAuth', deployment().name))).outputs.ExpressRouteAuthorizationKey.value]"
                  },
                  "ExpressRouteId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', format('{0}-ExRAuth', deployment().name))).outputs.ExpressRouteId.value]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "14454448833640497532"
                    }
                  },
                  "parameters": {
                    "GatewayName": {
                      "type": "string"
                    },
                    "ConnectionName": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "ExpressRouteAuthorizationKey": {
                      "type": "secureString"
                    },
                    "ExpressRouteId": {
                      "type": "secureString"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/connections",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('ConnectionName')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "connectionType": "ExpressRoute",
                        "routingWeight": 0,
                        "virtualNetworkGateway1": {
                          "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('GatewayName'))]",
                          "properties": {}
                        },
                        "peer": {
                          "id": "[parameters('ExpressRouteId')]"
                        },
                        "authorizationKey": "[parameters('ExpressRouteAuthorizationKey')]"
                      }
                    }
                  ],
                  "outputs": {
                    "ExRConnectionResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/connections', parameters('ConnectionName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('PrivateCloudResourceGroup')), 'Microsoft.Resources/deployments', format('{0}-ExRAuth', deployment().name))]"
              ]
            }
          ],
          "outputs": {
            "ExRConnectionResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('NetworkResourceGroup')), 'Microsoft.Resources/deployments', format('{0}-ExR', deployment().name))).outputs.ExRConnectionResourceId.value]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-AVS', variables('deploymentPrefix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-Network', variables('deploymentPrefix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-AVSAddons', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "PrivateCloudName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-AVS', variables('deploymentPrefix')))).outputs.PrivateCloudName.value]"
          },
          "PrivateCloudResourceGroup": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-AVS', variables('deploymentPrefix')))).outputs.PrivateCloudResourceGroupName.value]"
          },
          "DeployHCX": {
            "value": "[parameters('DeployHCX')]"
          },
          "DeploySRM": {
            "value": "[parameters('DeploySRM')]"
          },
          "SRMLicenseKey": {
            "value": "[parameters('SRMLicenseKey')]"
          },
          "VRServerCount": {
            "value": "[parameters('VRServerCount')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "11346226735746445858"
            }
          },
          "parameters": {
            "PrivateCloudName": {
              "type": "string"
            },
            "PrivateCloudResourceGroup": {
              "type": "string"
            },
            "DeployHCX": {
              "type": "bool"
            },
            "DeploySRM": {
              "type": "bool"
            },
            "SRMLicenseKey": {
              "type": "string"
            },
            "VRServerCount": {
              "type": "int",
              "maxValue": 10,
              "minValue": 1
            }
          },
          "resources": [
            {
              "condition": "[parameters('DeployHCX')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-HCX', deployment().name)]",
              "resourceGroup": "[parameters('PrivateCloudResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrivateCloudName": {
                    "value": "[parameters('PrivateCloudName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "9414882336870263525"
                    }
                  },
                  "parameters": {
                    "PrivateCloudName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.AVS/privateClouds/addons",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}/{1}', parameters('PrivateCloudName'), 'hcx')]",
                      "properties": {
                        "addonType": "HCX",
                        "offer": "VMware MaaS Cloud Provider"
                      }
                    }
                  ]
                }
              }
            },
            {
              "condition": "[parameters('DeploySRM')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-SRM', deployment().name)]",
              "resourceGroup": "[parameters('PrivateCloudResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrivateCloudName": {
                    "value": "[parameters('PrivateCloudName')]"
                  },
                  "SRMLicenseKey": {
                    "value": "[parameters('SRMLicenseKey')]"
                  },
                  "VRServerCount": {
                    "value": "[parameters('VRServerCount')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "15030845292505242552"
                    }
                  },
                  "parameters": {
                    "PrivateCloudName": {
                      "type": "string"
                    },
                    "SRMLicenseKey": {
                      "type": "string"
                    },
                    "VRServerCount": {
                      "type": "int",
                      "maxValue": 10,
                      "minValue": 1
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.AVS/privateClouds/addons",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}/{1}', parameters('PrivateCloudName'), 'srm')]",
                      "properties": {
                        "licenseKey": "[parameters('SRMLicenseKey')]",
                        "addonType": "SRM"
                      }
                    },
                    {
                      "type": "Microsoft.AVS/privateClouds/addons",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}/{1}', parameters('PrivateCloudName'), 'vr')]",
                      "properties": {
                        "vrsCount": "[parameters('VRServerCount')]",
                        "addonType": "VR"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.AVS/privateClouds/addons', parameters('PrivateCloudName'), 'srm')]"
                      ]
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-AVS', variables('deploymentPrefix')))]"
      ]
    },
    {
      "condition": "[parameters('DeployJumpbox')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-Jumpbox', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "Location": {
            "value": "[parameters('ELZLocation')]"
          },
          "Username": {
            "value": "[parameters('JumpboxUsername')]"
          },
          "Password": {
            "value": "[parameters('JumpboxPassword')]"
          },
          "VNetName": {
            "value": "[parameters('VNetName')]"
          },
          "VNetResourceGroup": {
            "value": "[parameters('NetworkResourceGroup')]"
          },
          "JumpboxSubnet": {
            "value": "[parameters('JumpboxSubnet')]"
          },
          "JumpboxSku": {
            "value": "[parameters('JumpboxSku')]"
          },
          "PublicIP": {
            "value": "[parameters('PublicIP')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "2121869391280049413"
            }
          },
          "parameters": {
            "Prefix": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "Username": {
              "type": "secureString"
            },
            "Password": {
              "type": "secureString"
            },
            "VNetResourceGroup": {
              "type": "string"
            },
            "VNetName": {
              "type": "string"
            },
            "JumpboxSubnet": {
              "type": "string"
            },
            "JumpboxSku": {
              "type": "string"
            },
            "PublicIP": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-Jumpbox', parameters('Prefix'))]",
              "location": "[parameters('Location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "Jumpbox-Subnet",
              "resourceGroup": "[parameters('VNetResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "VNetName": {
                    "value": "[parameters('VNetName')]"
                  },
                  "JumpboxSubnet": {
                    "value": "[parameters('JumpboxSubnet')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "10607862623737220148"
                    }
                  },
                  "parameters": {
                    "VNetName": {
                      "type": "string"
                    },
                    "Prefix": {
                      "type": "string"
                    },
                    "JumpboxSubnet": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "Name": "[format('{0}-jumpbox', parameters('Prefix'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2020-11-01",
                      "name": "[variables('Name')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "securityRules": [
                          {
                            "name": "AllowRDP",
                            "properties": {
                              "description": "This will allow RDP traffic into the subnet",
                              "protocol": "Tcp",
                              "sourcePortRange": "*",
                              "destinationPortRanges": [
                                "3389"
                              ],
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 100,
                              "direction": "Inbound"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/{1}', parameters('VNetName'), 'JumpBox')]",
                      "properties": {
                        "addressPrefix": "[parameters('JumpboxSubnet')]",
                        "networkSecurityGroup": {
                          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('Name'))]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('Name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "JumpBoxSubnetId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('VNetName'), 'JumpBox')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-VM', deployment().name)]",
              "resourceGroup": "[format('{0}-Jumpbox', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "SubnetId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('VNetResourceGroup')), 'Microsoft.Resources/deployments', 'Jumpbox-Subnet')).outputs.JumpBoxSubnetId.value]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Username": {
                    "value": "[parameters('Username')]"
                  },
                  "Password": {
                    "value": "[parameters('Password')]"
                  },
                  "VMSize": {
                    "value": "[parameters('JumpboxSku')]"
                  },
                  "PublicIP": {
                    "value": "[parameters('PublicIP')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "7384519999479240388"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "SubnetId": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "Username": {
                      "type": "string"
                    },
                    "Password": {
                      "type": "secureString"
                    },
                    "VMSize": {
                      "type": "string"
                    },
                    "OSVersion": {
                      "type": "string",
                      "defaultValue": "2019-Datacenter-smalldisk"
                    },
                    "PublicIP": {
                      "type": "bool"
                    }
                  },
                  "variables": {
                    "Name": "[format('{0}-jumpbox', parameters('Prefix'))]",
                    "Hostname": "avsjumpbox"
                  },
                  "resources": [
                    {
                      "condition": "[parameters('PublicIP')]",
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2019-11-01",
                      "name": "[variables('Name')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "publicIPAllocationMethod": "Dynamic"
                      }
                    },
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('Name')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "publicIPAddress": "[if(parameters('PublicIP'), createObject('id', resourceId('Microsoft.Network/publicIPAddresses', variables('Name'))), createObject())]",
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('SubnetId')]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', variables('Name'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2021-03-01",
                      "name": "[variables('Name')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('VMSize')]"
                        },
                        "osProfile": {
                          "computerName": "[variables('Hostname')]",
                          "adminUsername": "[parameters('Username')]",
                          "adminPassword": "[parameters('Password')]"
                        },
                        "storageProfile": {
                          "imageReference": {
                            "publisher": "MicrosoftWindowsServer",
                            "offer": "WindowsServer",
                            "sku": "[parameters('OSVersion')]",
                            "version": "latest"
                          },
                          "osDisk": {
                            "createOption": "FromImage",
                            "managedDisk": {
                              "storageAccountType": "Premium_LRS"
                            }
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('Name'))]"
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', variables('Name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "JumpboxResourceId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Compute/virtualMachines', variables('Name'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Jumpbox', parameters('Prefix')))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('VNetResourceGroup')), 'Microsoft.Resources/deployments', 'Jumpbox-Subnet')]"
              ]
            }
          ],
          "outputs": {
            "JumpboxResourceId": {
              "type": "string",
              "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Jumpbox', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-VM', deployment().name))).outputs.JumpboxResourceId.value]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('DeployMigrationSubnet')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-Migration', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "VNetName": {
            "value": "[parameters('VNetName')]"
          },
          "VNetResourceGroup": {
            "value": "[parameters('NetworkResourceGroup')]"
          },
          "MigrationSubnet": {
            "value": "[parameters('MigrationSubnet')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "14551826874482413203"
            }
          },
          "parameters": {
            "VNetResourceGroup": {
              "type": "string"
            },
            "VNetName": {
              "type": "string"
            },
            "MigrationSubnet": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "Migration-Subnet",
              "resourceGroup": "[parameters('VNetResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "VNetName": {
                    "value": "[parameters('VNetName')]"
                  },
                  "MigrationSubnet": {
                    "value": "[parameters('MigrationSubnet')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "10551283141920611488"
                    }
                  },
                  "parameters": {
                    "VNetName": {
                      "type": "string"
                    },
                    "MigrationSubnet": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/{1}', parameters('VNetName'), 'Migration')]",
                      "properties": {
                        "addressPrefix": "[parameters('MigrationSubnet')]"
                      }
                    }
                  ],
                  "outputs": {
                    "MigrationSubnetId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('VNetName'), 'Migration')]"
                    }
                  }
                }
              }
            }
          ]
        }
      }
    },
    {
      "condition": "[parameters('DeployStorage')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-Storage', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Name": {
            "value": "[format('{0}{1}', parameters('StorageName'), uniqueString(deployment().name))]"
          },
          "ResourceGroup": {
            "value": "[parameters('NetworkResourceGroup')]"
          },
          "Location": {
            "value": "[parameters('ELZLocation')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "14446094262720274354"
            }
          },
          "parameters": {
            "ResourceGroup": {
              "type": "string"
            },
            "Name": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "Storage-Account",
              "resourceGroup": "[parameters('ResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Name": {
                    "value": "[parameters('Name')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "15923081241325124891"
                    }
                  },
                  "parameters": {
                    "Name": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('Name')]",
                      "location": "[parameters('Location')]",
                      "kind": "StorageV2",
                      "sku": {
                        "name": "Standard_LRS"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-Monitoring', variables('deploymentPrefix'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AlertEmails": {
            "value": "[parameters('AlertEmails')]"
          },
          "Prefix": {
            "value": "[parameters('Prefix')]"
          },
          "PrimaryLocation": {
            "value": "[parameters('AVSLocation')]"
          },
          "PrimaryPrivateCloudName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-AVS', variables('deploymentPrefix')))).outputs.PrivateCloudName.value]"
          },
          "PrimaryPrivateCloudResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-AVS', variables('deploymentPrefix')))).outputs.PrivateCloudResourceId.value]"
          },
          "JumpboxResourceId": {
            "value": "[if(parameters('DeployJumpbox'), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-Jumpbox', variables('deploymentPrefix')))).outputs.JumpboxResourceId.value, '')]"
          },
          "VNetResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-Network', variables('deploymentPrefix')))).outputs.VNetResourceId.value]"
          },
          "ExRConnectionResourceId": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-VNet', variables('deploymentPrefix')))).outputs.ExRConnectionResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1272.37030",
              "templateHash": "2829467024668368261"
            }
          },
          "parameters": {
            "Prefix": {
              "type": "string"
            },
            "PrimaryLocation": {
              "type": "string"
            },
            "AlertEmails": {
              "type": "array"
            },
            "PrimaryPrivateCloudName": {
              "type": "string"
            },
            "PrimaryPrivateCloudResourceId": {
              "type": "string"
            },
            "JumpboxResourceId": {
              "type": "string"
            },
            "VNetResourceId": {
              "type": "string"
            },
            "ExRConnectionResourceId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-Operational', parameters('Prefix'))]",
              "location": "[parameters('PrimaryLocation')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-ActionGroup', deployment().name)]",
              "resourceGroup": "[format('{0}-Operational', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "ActionGroupEmails": {
                    "value": "[parameters('AlertEmails')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "10234831864174728285"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "ActionGroupEmails": {
                      "type": "array",
                      "defaultValue": []
                    }
                  },
                  "resources": [
                    {
                      "type": "microsoft.insights/actionGroups",
                      "apiVersion": "2019-06-01",
                      "name": "[format('{0}-ActionGroup', parameters('Prefix'))]",
                      "location": "Global",
                      "properties": {
                        "copy": [
                          {
                            "name": "emailReceivers",
                            "count": "[length(parameters('ActionGroupEmails'))]",
                            "input": {
                              "emailAddress": "[parameters('ActionGroupEmails')[copyIndex('emailReceivers')]]",
                              "name": "[split(parameters('ActionGroupEmails')[copyIndex('emailReceivers')], '@')[0]]",
                              "useCommonAlertSchema": false
                            }
                          }
                        ],
                        "enabled": true,
                        "groupShortName": "[substring(format('avs{0}', uniqueString(parameters('Prefix'))), 0, 12)]"
                      }
                    }
                  ],
                  "outputs": {
                    "ActionGroupResourceId": {
                      "type": "string",
                      "value": "[resourceId('microsoft.insights/actionGroups', format('{0}-ActionGroup', parameters('Prefix')))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Operational', parameters('Prefix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-MetricAlerts', deployment().name)]",
              "resourceGroup": "[format('{0}-Operational', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ActionGroupResourceId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Operational', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-ActionGroup', deployment().name))).outputs.ActionGroupResourceId.value]"
                  },
                  "AlertPrefix": {
                    "value": "[parameters('PrimaryPrivateCloudName')]"
                  },
                  "PrivateCloudResourceId": {
                    "value": "[parameters('PrimaryPrivateCloudResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "1157840457735554270"
                    }
                  },
                  "parameters": {
                    "AlertPrefix": {
                      "type": "string"
                    },
                    "ActionGroupResourceId": {
                      "type": "string"
                    },
                    "PrivateCloudResourceId": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "Alerts": [
                      {
                        "Name": "CPU",
                        "Description": "CPU Usage per Cluster",
                        "Metric": "EffectiveCpuAverage",
                        "SplitDimension": "clustername",
                        "Threshold": 80,
                        "Severity": 2
                      },
                      {
                        "Name": "Memory",
                        "Description": "Memory Usage per Cluster",
                        "Metric": "UsageAverage",
                        "SplitDimension": "clustername",
                        "Threshold": 80,
                        "Severity": 2
                      },
                      {
                        "Name": "Storage",
                        "Description": "Storage Usage per Datastore",
                        "Metric": "DiskUsedPercentage",
                        "SplitDimension": "dsname",
                        "Threshold": 70,
                        "Severity": 2
                      },
                      {
                        "Name": "StorageCritical",
                        "Description": "Storage Usage per Datastore",
                        "Metric": "DiskUsedPercentage",
                        "SplitDimension": "dsname",
                        "Threshold": 75,
                        "Severity": 0
                      }
                    ]
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "MetricAlert",
                        "count": "[length(variables('Alerts'))]"
                      },
                      "type": "Microsoft.Insights/metricAlerts",
                      "apiVersion": "2018-03-01",
                      "name": "[format('{0}-{1}', parameters('AlertPrefix'), variables('Alerts')[copyIndex()].Name)]",
                      "location": "Global",
                      "properties": {
                        "description": "[variables('Alerts')[copyIndex()].Description]",
                        "criteria": {
                          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                          "allOf": [
                            {
                              "name": "Metric1",
                              "operator": "GreaterThan",
                              "threshold": "[variables('Alerts')[copyIndex()].Threshold]",
                              "timeAggregation": "Average",
                              "criterionType": "StaticThresholdCriterion",
                              "metricName": "[variables('Alerts')[copyIndex()].Metric]",
                              "dimensions": [
                                {
                                  "name": "[variables('Alerts')[copyIndex()].SplitDimension]",
                                  "operator": "Include",
                                  "values": [
                                    "*"
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        "scopes": [
                          "[parameters('PrivateCloudResourceId')]"
                        ],
                        "severity": "[variables('Alerts')[copyIndex()].Severity]",
                        "evaluationFrequency": "PT5M",
                        "windowSize": "PT30M",
                        "autoMitigate": true,
                        "enabled": true,
                        "actions": [
                          {
                            "actionGroupId": "[parameters('ActionGroupResourceId')]"
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Operational', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-ActionGroup', deployment().name))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Operational', parameters('Prefix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-ServiceHealth', deployment().name)]",
              "resourceGroup": "[format('{0}-Operational', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "ActionGroupResourceId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Operational', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-ActionGroup', deployment().name))).outputs.ActionGroupResourceId.value]"
                  },
                  "AlertPrefix": {
                    "value": "[parameters('PrimaryPrivateCloudName')]"
                  },
                  "PrivateCloudResourceId": {
                    "value": "[parameters('PrimaryPrivateCloudResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "13524405542818990110"
                    }
                  },
                  "parameters": {
                    "AlertPrefix": {
                      "type": "string"
                    },
                    "ActionGroupResourceId": {
                      "type": "string"
                    },
                    "PrivateCloudResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/activityLogAlerts",
                      "apiVersion": "2020-10-01",
                      "name": "[format('{0}-ServiceHealth', parameters('AlertPrefix'))]",
                      "location": "Global",
                      "properties": {
                        "description": "Service Health Alerts",
                        "condition": {
                          "allOf": [
                            {
                              "field": "category",
                              "equals": "ServiceHealth"
                            },
                            {
                              "field": "properties.impactedServices[*].ServiceName",
                              "containsAny": [
                                "Azure VMware Solution"
                              ]
                            },
                            {
                              "field": "properties.impactedServices[*].ImpactedRegions[*].RegionName",
                              "containsAny": [
                                "[reference(parameters('PrivateCloudResourceId'), '2021-06-01', 'Full').location]",
                                "Global"
                              ]
                            }
                          ]
                        },
                        "scopes": [
                          "[subscription().id]"
                        ],
                        "enabled": true,
                        "actions": {
                          "actionGroups": [
                            {
                              "actionGroupId": "[parameters('ActionGroupResourceId')]"
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-Operational', parameters('Prefix'))), 'Microsoft.Resources/deployments', format('{0}-ActionGroup', deployment().name))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Operational', parameters('Prefix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('{0}-Dashboard', deployment().name)]",
              "resourceGroup": "[format('{0}-Operational', parameters('Prefix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Prefix": {
                    "value": "[parameters('Prefix')]"
                  },
                  "Location": {
                    "value": "[parameters('PrimaryLocation')]"
                  },
                  "PrivateCloudResourceId": {
                    "value": "[parameters('PrimaryPrivateCloudResourceId')]"
                  },
                  "JumpboxResourceId": {
                    "value": "[parameters('JumpboxResourceId')]"
                  },
                  "ExRConnectionResourceId": {
                    "value": "[parameters('ExRConnectionResourceId')]"
                  },
                  "VNetResourceId": {
                    "value": "[parameters('VNetResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1272.37030",
                      "templateHash": "16075589945352224887"
                    }
                  },
                  "parameters": {
                    "Prefix": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "JumpboxResourceId": {
                      "type": "string"
                    },
                    "PrivateCloudResourceId": {
                      "type": "string"
                    },
                    "VNetResourceId": {
                      "type": "string"
                    },
                    "ExRConnectionResourceId": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "DashboardHeading": {
                      "position": {
                        "colSpan": 6,
                        "rowSpan": 1,
                        "x": 0,
                        "y": 0
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/MarkdownPart",
                        "inputs": [],
                        "settings": {
                          "content": {
                            "settings": {
                              "content": "# AVS Private Cloud Metrics",
                              "title": "",
                              "subtitle": "",
                              "markdownSource": 1
                            }
                          }
                        }
                      }
                    },
                    "EmptyJumpboxLink": {
                      "position": {
                        "colSpan": 2,
                        "rowSpan": 1,
                        "x": 10,
                        "y": 0
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/MarkdownPart",
                        "inputs": [],
                        "settings": {
                          "content": {
                            "settings": {
                              "content": "",
                              "title": "",
                              "subtitle": "",
                              "markdownSource": 1
                            }
                          }
                        }
                      }
                    },
                    "VNetLink": {
                      "position": {
                        "colSpan": 2,
                        "rowSpan": 1,
                        "x": 8,
                        "y": 0
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/ResourcePart",
                        "asset": {
                          "idInputName": "id"
                        },
                        "inputs": [
                          {
                            "name": "id",
                            "value": "[parameters('VNetResourceId')]"
                          }
                        ]
                      }
                    },
                    "JumpboxLink": {
                      "position": {
                        "colSpan": 2,
                        "rowSpan": 1,
                        "x": 10,
                        "y": 0
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/ResourcePart",
                        "asset": {
                          "idInputName": "id"
                        },
                        "inputs": [
                          {
                            "name": "id",
                            "value": "[parameters('JumpboxResourceId')]"
                          }
                        ]
                      }
                    },
                    "PrivateCloudLink": {
                      "position": {
                        "colSpan": 2,
                        "rowSpan": 1,
                        "x": 6,
                        "y": 0
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/ResourcePart",
                        "asset": {
                          "idInputName": "id"
                        },
                        "inputs": [
                          {
                            "name": "id",
                            "value": "[parameters('PrivateCloudResourceId')]"
                          }
                        ]
                      }
                    },
                    "PrivateCloudCPUMetric": {
                      "position": {
                        "colSpan": 6,
                        "rowSpan": 4,
                        "x": 0,
                        "y": 1
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                        "inputs": [
                          {
                            "name": "options",
                            "value": {
                              "chart": {
                                "metrics": [
                                  {
                                    "resourceMetadata": {
                                      "id": "[parameters('PrivateCloudResourceId')]"
                                    },
                                    "name": "EffectiveCpuAverage",
                                    "aggregationType": 4,
                                    "namespace": "microsoft.avs/privateclouds",
                                    "metricVisualization": {
                                      "displayName": "Percentage CPU"
                                    }
                                  }
                                ],
                                "title": "Percentage CPU by Cluster Name",
                                "titleKind": 1,
                                "visualization": {
                                  "chartType": 2,
                                  "legendVisualization": {
                                    "isVisible": true,
                                    "position": 2,
                                    "hideSubtitle": false
                                  },
                                  "axisVisualization": {
                                    "x": {
                                      "isVisible": true,
                                      "axisType": 2
                                    },
                                    "y": {
                                      "isVisible": true,
                                      "axisType": 1
                                    }
                                  }
                                },
                                "grouping": {
                                  "dimension": "clustername",
                                  "sort": 2,
                                  "top": 10
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "PrivateCloudDiskMetric": {
                      "position": {
                        "colSpan": 6,
                        "rowSpan": 4,
                        "x": 6,
                        "y": 1
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                        "inputs": [
                          {
                            "name": "options",
                            "value": {
                              "chart": {
                                "metrics": [
                                  {
                                    "resourceMetadata": {
                                      "id": "[parameters('PrivateCloudResourceId')]"
                                    },
                                    "name": "DiskUsedPercentage",
                                    "aggregationType": 4,
                                    "namespace": "microsoft.avs/privateclouds",
                                    "metricVisualization": {
                                      "displayName": " Percentage Datastore Disk Used"
                                    }
                                  }
                                ],
                                "title": "Percentage Datastore Disk Used by Datastore",
                                "titleKind": 1,
                                "visualization": {
                                  "chartType": 2,
                                  "legendVisualization": {
                                    "isVisible": true,
                                    "position": 2,
                                    "hideSubtitle": false
                                  },
                                  "axisVisualization": {
                                    "x": {
                                      "isVisible": true,
                                      "axisType": 2
                                    },
                                    "y": {
                                      "isVisible": true,
                                      "axisType": 1
                                    }
                                  }
                                },
                                "grouping": {
                                  "dimension": "dsname",
                                  "sort": 2,
                                  "top": 10
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "PrivateCloudMemoryMetric": {
                      "position": {
                        "colSpan": 6,
                        "rowSpan": 4,
                        "x": 0,
                        "y": 5
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                        "inputs": [
                          {
                            "name": "options",
                            "value": {
                              "chart": {
                                "metrics": [
                                  {
                                    "resourceMetadata": {
                                      "id": "[parameters('PrivateCloudResourceId')]"
                                    },
                                    "name": "UsageAverage",
                                    "aggregationType": 4,
                                    "namespace": "microsoft.avs/privateclouds",
                                    "metricVisualization": {
                                      "displayName": "Average Memory Usage"
                                    }
                                  }
                                ],
                                "title": "Average Memory Usage by Cluster Name",
                                "titleKind": 1,
                                "visualization": {
                                  "chartType": 2,
                                  "legendVisualization": {
                                    "isVisible": true,
                                    "position": 2,
                                    "hideSubtitle": false
                                  },
                                  "axisVisualization": {
                                    "x": {
                                      "isVisible": true,
                                      "axisType": 2
                                    },
                                    "y": {
                                      "isVisible": true,
                                      "axisType": 1
                                    }
                                  }
                                },
                                "grouping": {
                                  "dimension": "clustername",
                                  "sort": 2,
                                  "top": 10
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "ExpressRouteConnectionsMetric": {
                      "position": {
                        "colSpan": 6,
                        "rowSpan": 4,
                        "x": 6,
                        "y": 5
                      },
                      "metadata": {
                        "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                        "inputs": [
                          {
                            "name": "options",
                            "value": {
                              "chart": {
                                "metrics": [
                                  {
                                    "resourceMetadata": {
                                      "id": "[parameters('ExRConnectionResourceId')]"
                                    },
                                    "name": "BitsInPerSecond",
                                    "aggregationType": 4,
                                    "namespace": "microsoft.network/connections",
                                    "metricVisualization": {
                                      "displayName": "BitsInPerSecond"
                                    }
                                  },
                                  {
                                    "resourceMetadata": {
                                      "id": "[parameters('ExRConnectionResourceId')]"
                                    },
                                    "name": "BitsOutPerSecond",
                                    "aggregationType": 4,
                                    "namespace": "microsoft.network/connections",
                                    "metricVisualization": {
                                      "displayName": "BitsOutPerSecond"
                                    }
                                  }
                                ],
                                "title": "Private Cloud to VNet Utilization",
                                "titleKind": 1,
                                "visualization": {
                                  "chartType": 2,
                                  "legendVisualization": {
                                    "isVisible": true,
                                    "position": 2,
                                    "hideSubtitle": false
                                  },
                                  "axisVisualization": {
                                    "x": {
                                      "isVisible": true,
                                      "axisType": 2
                                    },
                                    "y": {
                                      "isVisible": true,
                                      "axisType": 1
                                    }
                                  }
                                },
                                "grouping": {
                                  "dimension": "dsname",
                                  "sort": 2,
                                  "top": 10
                                }
                              }
                            }
                          }
                        ]
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Portal/dashboards",
                      "apiVersion": "2019-01-01-preview",
                      "name": "[format('{0}-Dashboard', parameters('Prefix'))]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "lenses": {
                          "0": {
                            "order": 0,
                            "parts": {
                              "0": "[variables('DashboardHeading')]",
                              "1": "[variables('PrivateCloudLink')]",
                              "2": "[if(empty(parameters('JumpboxResourceId')), variables('EmptyJumpboxLink'), variables('JumpboxLink'))]",
                              "3": "[variables('VNetLink')]",
                              "4": "[variables('PrivateCloudDiskMetric')]",
                              "5": "[variables('PrivateCloudCPUMetric')]",
                              "6": "[variables('PrivateCloudMemoryMetric')]",
                              "7": "[variables('ExpressRouteConnectionsMetric')]"
                            }
                          }
                        }
                      },
                      "tags": {
                        "hidden-title": "[format('{0}-Dashboard', parameters('Prefix'))]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-Operational', parameters('Prefix')))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-AVS', variables('deploymentPrefix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-Jumpbox', variables('deploymentPrefix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-Network', variables('deploymentPrefix')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('{0}-VNet', variables('deploymentPrefix')))]"
      ]
    }
  ]
}